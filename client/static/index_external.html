<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALMA - Plataforma</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4a6fa5;
      --primary-hover: #166088;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
      --text-light: #ffffff;
      --text-muted: #dddddd;
      --bg-transparent: rgba(0, 0, 0, 0.7);
    }
    
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      box-sizing: border-box;
    }
    
    html, body {
      min-height: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      height: 100vh;
      background: url('https://images.unsplash.com/photo-1639762681057-408e52192e55?q=80&w=2232&auto=format&fit=crop') no-repeat center center fixed;
      background-size: cover;
      color: var(--text-light);
      display: flex;
      flex-direction: column;
    }

    #auth-section {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.3);
    }
    
    #login-form {
      background: var(--bg-transparent);
      padding: 30px 25px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      text-align: center;
      backdrop-filter: blur(5px);
    }
    
    @media (max-width: 480px) {
      #login-form {
        padding: 20px 15px;
        margin: 0 10px;
      }
    }
    
    .login-header {
      margin-bottom: 25px;
    }
    
    .login-header h1 {
      font-size: 2.2rem;
      margin: 0;
      color: var(--text-light);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .login-header h2 {
      font-size: 1.3rem;
      margin: 10px 0 0;
      font-weight: 400;
      color: var(--text-muted);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }
    
    .form-group {
      margin-bottom: 18px;
      text-align: left;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-muted);
    }
    
    .form-control {
      width: 100%;
      padding: 14px 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      background-color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s;
    }
    
    .form-control:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.3);
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    
    .btn:hover {
      background: var(--primary-hover);
    }
    
    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .hidden {
        display: none;
    }
    
    .error-label {
      color: var(--error-color);
      font-size: 0.9em;
      margin-top: 5px;
      display: block;
    }
    
    .input-error {
      border: 2px solid var(--error-color) !important;
    }
    
    #auth-loading {
      margin: 15px 0;
      color: var(--text-muted);
      font-style: italic;
    }
    
    .server-status {
        text-align: center;
        margin: 15px 0;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
    }

    .server-status.online {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        border: 1px solid rgba(76, 175, 80, 0.5);
    }

    .server-status.offline {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
        border: 1px solid rgba(244, 67, 54, 0.5);
    }

    .server-status.checking {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.5);
    }

    .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .connection-info {
        margin-top: 20px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        font-size: 12px;
        text-align: center;
        word-break: break-all;
    }
  </style>
</head>
<body>
<div id="mobile-loading" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    font-size: 18px;
">
    <div style="text-align: center; padding: 20px;">
        <div style="font-size: 24px; margin-bottom: 20px;">üåê</div>
        <div>Conectando √† plataforma ALMA...</div>
        <div style="font-size: 14px; margin-top: 10px; opacity: 0.8;" id="loading-details">Inicializando</div>
    </div>
</div>

<div id="auth-section">
    <form id="login-form">
        <div class="login-header">
            <h1>ALMA</h1>
            <h2>LOGIN</h2>
        </div>
        
        <div id="server-status" class="server-status checking">
            <span class="loading-spinner"></span> Verificando conex√£o...
        </div>
        
        <div class="form-group">
            <label for="email">E-mail</label>
            <input type="email" id="email" class="form-control" placeholder="Digite seu e-mail" required />
            <span id="email-error" class="error-label hidden"></span>
        </div>
        
        <div class="form-group">
            <label for="password">Senha</label>
            <input type="password" id="password" class="form-control" placeholder="Digite sua senha" required />
            <span id="password-error" class="error-label hidden"></span>
        </div>
        
        <button type="submit" class="btn" id="login-btn">
            Entrar
        </button>
        
        <div id="auth-loading" class="hidden">
            <span class="loading-spinner"></span> Autenticando...
        </div>
        
        <div id="login-error" class="error-label hidden"></div>

        <button id="retry-button" class="btn hidden">
            Tentar Novamente
        </button>

        <div id="connection-info" class="connection-info hidden">
            Conectando atrav√©s de: <span id="connection-url"></span>
        </div>
    </form>
</div>

<script>
class AlmaLogin {
    constructor() {
        this.isSubmitting = false;
        this.serverUrl = window.location.hostname === 'almafluxo.uk' 
            ? window.location.origin 
            : 'https://almafluxo.uk';
        
        console.log('üöÄ DEBUG - URL Completa:', window.location.href);
        console.log('üöÄ DEBUG - Origin:', window.location.origin);
        console.log('üöÄ DEBUG - Hostname:', window.location.hostname);
        console.log('üöÄ DEBUG - Server URL:', this.serverUrl);
        
        this.init();
    }

    // ==================== FUN√á√ïES AUXILIARES ====================
    
    showLoading(message = "Carregando...") {
        this.isSubmitting = true;
        const authLoading = document.getElementById('auth-loading');
        const loginBtn = document.getElementById('login-btn');
        
        if (authLoading) {
            authLoading.innerHTML = `<span class="loading-spinner"></span> ${message}`;
            authLoading.classList.remove('hidden');
        }
        
        if (loginBtn) {
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading-spinner"></span> Entrando...';
        }
    }

    hideLoading() {
        this.isSubmitting = false;
        const authLoading = document.getElementById('auth-loading');
        const loginBtn = document.getElementById('login-btn');
        
        if (authLoading) authLoading.classList.add('hidden');
        if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.innerHTML = 'Entrar';
        }
    }

    showError(message) {
        const errorEl = document.getElementById('login-error');
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
    }

    hideError() {
        const errorEl = document.getElementById('login-error');
        if (errorEl) errorEl.classList.add('hidden');
    }

    getErrorMessage(error) {
        if (error.name === 'AbortError') return 'Tempo limite excedido. Verifique sua conex√£o.';
        if (error.message.includes('Failed to fetch')) return 'N√£o foi poss√≠vel conectar ao servidor.';
        return error.message || 'Erro desconhecido.';
    }

    validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
    }

    // ==================== FUN√á√ïES PRINCIPAIS ====================
    
    init() {
        this.hideLoadingScreenAfterDelay();
        this.setupListeners();
        this.checkServerConnection();
    }

    hideLoadingScreenAfterDelay() {
        setTimeout(() => {
            const loadingScreen = document.getElementById('mobile-loading');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => loadingScreen.style.display = 'none', 500);
            }
        }, 500);
    }

    setupListeners() {
        document.getElementById('login-form')?.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleLogin();
        });
        
        document.getElementById('retry-button')?.addEventListener('click', () => {
            this.hideError();
            document.getElementById('retry-button').classList.add('hidden');
            this.checkServerConnection();
        });
    }

    async checkServerConnection() {
        this.updateServerStatus('<span class="loading-spinner"></span> Verificando conex√£o...', 'checking');
        try {
            const response = await fetch(`${this.serverUrl}/health`, {
                signal: AbortSignal.timeout(8000)
            });
            
            if (!response.ok) throw new Error(`Status: ${response.status}`);
            
            this.updateServerStatus('‚úÖ Conectado ao servidor', 'online');
            this.showConnectionInfo(this.serverUrl);
            
        } catch (error) {
            console.error('Erro na conex√£o:', error);
            this.updateServerStatus('‚ùå Servidor indispon√≠vel', 'offline');
            document.getElementById('retry-button').classList.remove('hidden');
        }
    }

    async handleLogin() {
        if (this.isSubmitting) return;

        const email = document.getElementById('email')?.value;
        const password = document.getElementById('password')?.value;

        if (!email || !this.validateEmail(email) || !password) {
            this.showError('Por favor, preencha e-mail e senha v√°lidos.');
            return;
        }

        // ‚úÖ CORRE√á√ÉO: Usar as fun√ß√µes corretas
        this.showLoading('Autenticando...');
        this.hideError();

        try {
            console.log('üì§ Enviando login para:', `${this.serverUrl}/login`);
            
            const response = await fetch(`${this.serverUrl}/login`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
                body: JSON.stringify({ email, password }),
                signal: AbortSignal.timeout(15000)
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || `Erro ${response.status}`);
            }
            
            this.handleLoginSuccess(data);

        } catch (error) {
            console.error('Erro no login:', error);
            this.showError(this.getErrorMessage(error));
            
        } finally {
            this.hideLoading();
        }
    }

    handleLoginSuccess(data) {
        console.log('‚úÖ DEBUG - Login bem-sucedido:', data);
        
        const hubUrl = data.data?.hub_url;
        
        if (!hubUrl) {
            console.error('‚ùå DEBUG - hub_url n√£o encontrada:', data);
            throw new Error('URL do Hub n√£o recebida do servidor');
        }
        
        console.log('üîÑ DEBUG - Redirecionando para:', hubUrl);
        window.location.href = hubUrl;
    }

    updateServerStatus(message, type) {
        const statusEl = document.getElementById('server-status');
        if (statusEl) {
            statusEl.innerHTML = message;
            statusEl.className = `server-status ${type}`;
        }
    }

    showConnectionInfo(url) {
        const infoEl = document.getElementById('connection-info');
        const urlEl = document.getElementById('connection-url');
        if (infoEl && urlEl) {
            urlEl.textContent = url;
            infoEl.classList.remove('hidden');
        }
    }
}

// Polyfill para AbortSignal.timeout
if (typeof AbortSignal.timeout !== 'function') {
    AbortSignal.timeout = (ms) => {
        const ctrl = new AbortController();
        setTimeout(() => ctrl.abort(new DOMException('TimeoutError')), ms);
        return ctrl.signal;
    };
}

document.addEventListener('DOMContentLoaded', () => {
    window.almaLogin = new AlmaLogin();
});
</script>
</body>
</html>